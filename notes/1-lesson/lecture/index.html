
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Design Patterns for Blockchain</title>

    <meta name="author" content="Dhruvin Parikh">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="../../../reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../../../reveal.js/css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../../../reveal.js/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../../../reveal.js/css/print/pdf.css' : '../../../reveal.js/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="../reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->

    <style>
      .reveal .slides h1, .reveal .slides h2, .reveal .slides h3 {
        text-transform: none;
      }

      .two-column {
        display: flex;
        flex-wrap: wrap;
      }

      .two-column em {
        margin: 20px;
      }

      .reveal .big-and-bold {
        font-weight: bold;
        font-size: 135%;
      }

      .reveal .shrunk-a-bit {
        font-size: 90%;
      }

      .reveal .shrunk-a-bit pre {
        width: 100%;
      }

      .reveal pre {
        width: 100%;
      }

      .reveal .highlight {
        color: yellow;
        font-weight: bold;
      }

      .reveal .highlightRed {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="reveal">
      <div class="slides">

<!------------------------------------------------------->



<section data-markdown><script type="text/template">

## BCDV 1011 - Design Patterns for Blockchain

### Lesson 1 - Common Patterns

*Dhruvin Parikh, December 2021*

</script></section>

<section data-markdown><script type="text/template">
## `$WHOAMI`  
- I am fullstack javascript developer, blockchain developer and an Instructor  
- CTO and Lead Blockchain Developer at opty.fi
- Also Blockchain Instructor at York University in Blockchain Development Program 
</script></section>

<section data-markdown><script type="text/template">

## Class Plan
* Authorization
* Control
* Maintenance
* Security
</script></section>

<section data-markdown><script type="text/template">

## Authorization

* Access restriction
* Multiple authorization
* Ownership
* Roles

</script></section>

<section data-markdown><script type="text/template">

## Access restriction

* Limit what account can do an action
* Can use a modifier

```
  modifier restriction(bool _condition) {
    require(_condition);
    _;
  }
  
  function transferOwnership(address newOwner) public onlyOwner 
  restriction(newOwner != address(0)) {
    ...
  }
```

</script></section>

<section data-markdown><script type="text/template">

## Multiple Authorization

* Require more than one account to do an action
* Can be M of N
* Owner to set N, M of N to change
* Danger if several keys are lost

</script></section>

<section data-markdown><script type="text/template">

  ## Ownership
    
  * Restricts features of contract to owner
  * Allows for transfer of ownership
  * OpenZeppelin code for pattern 
    
</script></section>
  
  <section data-markdown><script type="text/template">
  
  ## Roles
    
  * Role Based Access Control (RBAC)
  * Create roles●Assign users to roles
  * Assign roles to methods
  * OpenZeppelin implementation
  </script></section>
  
  
  <section data-markdown><script type="text/template">
  
  ## Security

  * Balance Limit
  * Checks-effects-interaction
  * Emergency Stop
  * Mutex
  * Rate Limit
  * Secure Transfer
  * Speed Bump
    
  </script></section>
  
<section data-markdown><script type="text/template">

## Balance Limit

* Set a lower limit on account balance 

```
  uint256 public limit; 

  function LimitBalance(uint256 value) public {   
    limit = value; 
  } 

  modifier limitedPayable() {   
    require(this.balance <= limit);   
    _; 
  } 

  function deposit() public payable limitedPayable {   
    // some code 
  }
```        
</script></section>



<section data-markdown><script type="text/template">

## Checks-effects-interaction

* Avoid problems with stack and reentrancy   

```
  function withdraw(uint amount) public {        
    require(balances[msg.sender] >= amount);        
    balances[msg.sender] -= amount;        
    msg.sender.transfer(amount);    
  }
```

</script></section>

<section data-markdown><script type="text/template">

  ## Emergency Stop
  
  * Stop or pause transfers
  * Overcome concerns with immutability
  * Could be abused
  
  </script></section>

<section data-markdown><script type="text/template">

## Mutex

* A way to avoid reentrancy

```
  mapping(address => bool) mutex;

  modifier preventRecursion() {    
    if(mutex[msg.sender] == false) {    
      mutex[msg.sender] = true;    
      _;    
      mutex[msg.sender] = false;    
    }
  }
```
</script></section>

<section data-markdown><script type="text/template">

## Rate Limit

* Limit how often a function can happen over time
```
  uint enabledAt = now; 
  modifier enabledEvery(uint t) {   
    if (now >= enabledAt) {     
      enabledAt = now + t;     
      _;   
    } 
  } 
  function f() public enabledEvery(1 minutes) {   
    // some code 
  }
```

</script></section>

<section data-markdown><script type="text/template">
  
## Secure Transfer
  
 * Secure transfer of eth from a contract to an account
 * Handles errors 
 * Handles reentrancy 
  
</script></section>

<section data-markdown><script type="text/template">

## Speed Bump 

* Put in a delay for an action to happen
* Can put in controls to revert the action
* 24hr waiting period
</script></section>

<section data-markdown><script type="text/template">

## Control 

```
* Commit and Reveal
* Guard Check
* Memory Array Building
* Oracle
* Poll
* Pull Payment
* Randomness
* Safemath (Below 0.8.0)
* State Machine
* String Equality Comparison
* Token
```
</script></section>

<section data-markdown><script type="text/template">

## Commit and Reveal

* Commit a hash, then once all hashes are in, reveal actual values and verify with hash
* Gets around transparency of blockchain 

</script></section>



<section data-markdown><script type="text/template">

  ## Guard Check

  * Validate parameters
  * Check contract state
  * Rule out strange conditions 

</script></section>

<section data-markdown><script type="text/template">

## Memory Array Building

* Avoid gas fees for retrieving storage
* Use a view function to get the storage for free
</script></section>



<section data-markdown><script type="text/template">

  ## Oracle
  
  * Get off chain data on chain
  * Can be used by multiple contracts
  
</script></section>


<section data-markdown><script type="text/template">

## Poll

* Polling or voting
* Used for group consensus 

</script></section>
  
  
<section data-markdown><script type="text/template">

## Pull Payment

* Recipient asks for payment
* Contract sends 
* Good for multiple payments in a transaction
* Recipient pays gas fee

</script></section>

<section data-markdown><script type="text/template">

## Randomness 
  
* Generate a random number
* Avoid predictability
* Block hash PRNG - the hash of a block as source of randomness
* Oracle RNG - randomness provided by an oracle, see Oracle pattern
* Collaborative PRNG - collaborative generation of a random number within the blockchain
  
</script></section>

<section data-markdown><script type="text/template">

## SafeMath (for Solidity version below 0.8.0) 
  
* Avoid overflows
* ALWAYS USE
* Also, multiply before you divide
  
</script></section>

<section data-markdown><script type="text/template">

## State Machine 
  
* Ensure contract passes through specific states
  
</script></section>

<section data-markdown><script type="text/template">

## String Equality Comparison
  
* Reduce gas of string comparison
* If equal length, compare hash
  
</script></section>

<section data-markdown><script type="text/template">

## Token
  
* Basic asset transfer control
  
</script></section>

<section data-markdown><script type="text/template">

## Maintenance
  
* Automatic Deprecation
* Contract composer
* Contract Factory
* Contract Registry
* Contract Relay
* Data Segregation
* Mortal
* Satellite
  
</script></section>

<section data-markdown><script type="text/template">

## Mappings
  
* Smart contracts are based on two things transfers and shared state
* Mappings are key/value pairs
* Mappings in Solidity are assumed infinite
* The value of a mapping can be a value, another mapping or a structure
* Tokens use mappings to track the owning accounts
* Registries use mappings to track who is in the registry
  
</script></section>

<section data-markdown><script type="text/template">

  ## Mappings
    
  ```
  key1 => Value1
  .... => .....
  keyn => Valuen
  ```
  ```
  mapping(key_type => value_type)
  mapping(address => uint) public balances;
  balances[msg.sender] = deposit;
  ```
    
  </script></section>


<section data-markdown><script type="text/template">

## Mappings
  
```
  struct Student {
    uint age; 
    string name;
  }
  mapping (address => Student) public class;
  Student memory newStudent;
  newStudent.age = 21;
  newStudent.name = “Alice”;
  class[msg.sender]=newStudent;
```
</script></section>


<section data-markdown><script type="text/template">

## Mappings
  
```
  mapping(address => mapping(uint => bool)) lotterypicks;
  lotterypicks[msg.sender][2456738992] = true;
```
</script></section>

<section data-markdown><script type="text/template">

## Mappings
  
* There is no order to a mapping through solidity
* You can’t iterate over a mapping
* There is no syntax like in other languages where you can loop though the contents of a collection
* You would have to go back to the ledger to see all of the transactions that resulted in entries to the mapping
</script></section>

<section data-markdown><script type="text/template">

## Iterators
  
* You still need to iterate in some cases
* Make sure that your case is bounded by a low enough amount that you do not run out of gas
* If you need to iterate over a larger number of items - don’t use Ethereum
</script></section>

<section data-markdown><script type="text/template">

## Arrays
  
* Arrays respect order 
* Arrays have random access
* Arrays can provide a count
</script></section>

<section data-markdown><script type="text/template">

## Arrays
  
```
  uint[] prices;
  prices.push(55);
  prices.push(23);
  uint[5] prices;
  prices[0] = 55;
  uint[5] prices = [uint(55), 23, 137, 67, 2];
```
</script></section>


<section data-markdown><script type="text/template">

## Arrays
  
```
  struct Student {
    uint age; 
    string name;
  }
  Student[ ] public class;
  Student memory newStudent;
  newStudent.age = 21;
  newStudent.name = “Alice”;
  class.push(newStudent);
```
</script></section>

<section data-markdown><script type="text/template">

## Further Readings
* [Advances Role Based Access Control](https://hiddentao.com/archives/2020/03/21/advanced-role-based-access-control-in-solidity)
* [OpenZeppelin Access Control](https://docs.openzeppelin.com/contracts/4.x/api/access)
* [Protect Smart Contracts from Reentrancy attacks](https://medium.com/coinmonks/protect-your-solidity-smart-contracts-from-reentrancy-attacks-9972c3af7c21)
* [Blockchain Oracle Problem](https://blog.chain.link/what-is-the-blockchain-oracle-problem/)
</script></section>

<section data-markdown><script type="text/template">

## End of Class

</script></section>


<!------------------------------------------------------->


      </div>

    </div>

    <script src="../../../reveal.js/lib/js/head.min.js"></script>
    <script src="../../../reveal.js/js/reveal.js"></script>
    <script src="../../../reveal.js/plugin/zoom-js/zoom.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'none', // none/fade/slide/convex/concave/zoom

	math: {
          mathjax: '../../../lib/MathJax/MathJax.js',
          config: 'TeX-AMS_SVG-full',
	},

        // Optional reveal.js plugins
        dependencies: [
          { src: '../../../reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../../../reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../../../reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../../../reveal.js/plugin/math/math.js', async: true }
        ]
      });

    </script>

  </body>
</html>